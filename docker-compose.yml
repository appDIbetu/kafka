version: '3.3'

services:
  zookeeper:
    image: 'wurstmeister/zookeeper'
    ports:
      - '2181:2181'
    networks:
       kafka:
        aliases:
          - kafka
  
          
  kafka:  
      image: wurstmeister/kafka:latest
      deploy: 
            mode: global
      
      ports:
       - "9094:9094"
       - "19092:19092"

      environment: 
         HOSTNAME_COMMAND: "docker info | grep ^Name: | cut -d' ' -f 2"
         KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
         KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INSIDE:PLAINTEXT,OUTSIDE:PLAINTEXT
         #HOSTNAME_COMMAND: curl http://169.254.169.254/hetzner/v1/metadata/hostname
         #KAFKA_ADVERTISED_LISTENERS: INSIDE://:19092,OUTSIDE:168.119.119.105
         KAFKA_ADVERTISED_LISTENERS: INSIDE://:19092,OUTSIDE://_{HOSTNAME_COMMAND}:9094
         KAFKA_LISTENERS: INSIDE://:19092,OUTSIDE://:9094
         KAFKA_INTER_BROKER_LISTENER_NAME: INSIDE
         KAFKA_CREATE_TOPICS: myTopic:3:3
      volumes:
         - /var/run/docker.sock:/var/run/docker.sock
      networks:
       kafka:
        aliases:
          - kafka

networks:
  kafka:
    external: true